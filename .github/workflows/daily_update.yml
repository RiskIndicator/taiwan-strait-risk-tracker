name: Daily Risk Tracker
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      post_tweet:
        description: 'Post to Twitter?'
        required: true
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    outputs:
      tweet_output: ${{ steps.build.outputs.tweet }}
      image_output: ${{ steps.build.outputs.image_url }}
    steps:
      - uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Build Scripts
        id: build
        run: |
          python build.py
          python build_ai.py
          python build_k_shape.py
          python build_supply.py
          python build_fiat.py
        
      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "Daily Update"
            git pull --rebase origin main
            git push
          else
            echo "No changes to commit."
          fi

  post-to-twitter:
    runs-on: ubuntu-latest
    needs: update-data  # Make sure this matches your build job name
    # ONLY run on schedule or if you manually check the 'post_tweet' box
    if: github.event_name == 'schedule' || inputs.post_tweet == true
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Tweepy
        run: pip install tweepy

      - name: Run Tweet Script
        env:
          # Use double quotes and exact names
          TWITTER_API_KEY: "${{ secrets.TWITTER_API_KEY }}"
          TWITTER_API_SECRET: "${{ secrets.TWITTER_API_SECRET }}"
          TWITTER_ACCESS_TOKEN: "${{ secrets.TWITTER_ACCESS_TOKEN }}"
          TWITTER_ACCESS_SECRET: "${{ secrets.TWITTER_ACCESS_SECRET }}"
          RISK_SCORE: "${{ needs.update-data.outputs.risk_score }}"
        run: python send_tweet.py